
<section [@fadeInOnEnter] [@fadeOutOnLeave]>
  <nb-card accent="primary">
    <nb-card-header >
      <h4>Envio de produção</h4>
      <p>Tela destinada ao envio dos arquivos XML de produção</p>
    </nb-card-header>
    <nb-card-body>
      <div class="text-left"
           [@fadeInOnEnter] [@fadeOutOnLeave]>
        <div class="upload-container"
             [@fadeInOnEnter] [@fadeOutOnLeave]
             *ngIf="viewState < 2">
          <ngx-file-drop
            dropZoneClassName="teste"
            contentClassName="custom-content"
            dropZoneLabel="Arraste os arquivos aqui"
            (onFileDrop)="dropped($event)"
            (onFileOver)="fileOver($event)"
            (onFileLeave)="fileLeave($event)">
            <ng-template ngx-file-drop-content-tmp
                         class="color-primary-500"
                         let-openFileSelector="openFileSelector">
              Arraste os arquivos para esta área ou clique no botão ao lado para
              <button nbButton  style="margin-left: 10px;" size="small"
                      status="info"
                      (click)="openFileSelector()">Selecionar arquivos</button>
            </ng-template>
          </ngx-file-drop>
        </div>
        <div class="upload-table mt-3"
             *ngIf="files.length > 0"
             [@fadeInOnEnter] [@fadeOutOnLeave]>
          <table class="table table-striped">
            <thead>
            <tr>
              <th class="sticky-header" colspan="2">Arquivo</th>
              <th class="sticky-header text-right"><button nbButton outline size="tiny" status="danger" *ngIf="viewState < 2 && viewState > 0"  (click)="removeAll()  ">apagar todos</button></th>
            </tr>
            </thead>
            <tbody class="upload-name">
            <tr *ngFor="let item of files; let i=index">
              <td>{{i}}</td>
              <td style="max-width: calc(100vw - 280px); text-overflow: ellipsis; overflow: hidden;
white-space: nowrap;">{{ item.relativePath }}</td>
              <td class="text-right"><button nbButton outline size="tiny" *ngIf="viewState < 2 && viewState > 0" class="grow-button" status="danger" (click)="removeItem(i)"><nb-icon [icon]="'trash-2-outline'"></nb-icon><span class="grow-content">apagar</span></button></td>
            </tr>
            <tr *ngIf="files.length <= 0">
              <td colspan="2"><strong>Nenhum arquivo selecionado</strong></td>
            </tr>
            </tbody>
          </table>
        </div>
        <div *ngIf="files.length > 0">
          <div class="text-right"><strong>{{files.length}}</strong> arquivos</div>
        </div>
        <div class="confirm-container text-center mt-3" *ngIf="viewState < 2 && viewState > 0 && files.length > 0" [@fadeInOnEnter] [@fadeOutOnLeave]>
          <button nbButton size="medium" class="grow-button" status="primary" (click)="sendToAnalysis()"><span>Analisar seleção</span></button>
        </div>
      </div>
    </nb-card-body>
  </nb-card>

  <nb-card [@fadeInOnEnter] [@fadeOutOnLeave]
  *ngIf="viewState >= 2">
    <nb-card-body>
      <div class="mb-5 ">
        <h4>Resumo da transação</h4>
        <p class="text-desc">Confira abaixo a análise dos dados enviados</p>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; grid-gap: 20px;">
        <nb-card status="info">
          <nb-card-header>Total</nb-card-header>
          <nb-card-body>
            <h2>{{totalLinhas | number}}</h2>
          </nb-card-body>
        </nb-card>

        <nb-card status="primary">
          <nb-card-header>Corretas</nb-card-header>
          <nb-card-body>
            <h2>{{totalCorretas | number}}</h2>
          </nb-card-body>
        </nb-card>

        <nb-card status="danger">
          <nb-card-header>Divergências</nb-card-header>
          <nb-card-body>
            <h2>{{totalAdvertencias | number}}</h2>
          </nb-card-body>
        </nb-card>

        <nb-card status="{{statusPercent}}">
          <nb-card-header>
            <span [ngClass]="{'text-black-50': percentResult < 0.2}">Resultado</span>
          </nb-card-header>
          <nb-card-body>
            <h2>{{ percentResult | percent}}</h2>
<!--            <input type="text" nbInput fullWidth shape="round" [(ngModel)]="percentResult" placeholder="{{percentResult | percent}}">-->
          </nb-card-body>
        </nb-card>
      </div>
      <div class="mt-4">
        <nb-alert *ngIf="checkPercent()" accent="primary">Sua transação de envio de produção foi aprovada e enviada para nossa equipe.</nb-alert>
        <nb-alert *ngIf="!checkPercent()" accent="danger">A transação foi reprovada. Confira na lista abaixo os arquivos com erro, corrija-os e tente novamente.</nb-alert>

        <div *ngIf="!checkPercent()" [@fadeInOnEnter] [@fadeOutOnLeave]>
          <table class="table">
            <thead>
              <tr>
                <th class="sticky-header" colspan="2">Arquivo</th>
                <th class="sticky-header text-right"></th>
              </tr>
            </thead>
            <tbody class="upload-name">
            <tr *ngFor="let item of files; let i=index" (click)="openWindow(item)">
              <td>{{i}}</td>
              <td style="max-width: calc(100vw - 280px); text-overflow: ellipsis; overflow: hidden;
white-space: nowrap;">{{ item.relativePath }}</td>
              <td class="text-right text-danger">{{(3) | number}} itens com erro</td>
            </tr>
            <tr *ngIf="files.length <= 0">
              <td colspan="2"><strong>Nenhum arquivo selecionado</strong></td>
            </tr>
            </tbody>
          </table>
        </div>

      </div>
    </nb-card-body>
  </nb-card>
</section>


<ng-template #popoverDivergencias let-data fullWidth="true">
  <table class="table table-striped" style="width: 900px !important;" >
    <thead>
      <tr>
        <td>Cod. Procedimento</td>
        <td>Dt. Atendimento</td>
        <td>Valor Total</td>
        <td>Status</td>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let item of listaDivergencias">
        <td>{{item.codProcedimento}}</td>
        <td>{{item.dataExecucao | date: 'short'}}</td>
        <td>{{item.valorTotal | currency: 'BRL': true}}</td>
        <td class="text-danger">{{item.descStatus}}</td>
      </tr>
    </tbody>
  </table>
</ng-template>
